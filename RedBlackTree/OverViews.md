# 赤黒木の概要
赤黒木のことや基本的な操作について簡単にまとめておく.
## 赤黒木とは
赤黒木に入る前に二分探索木について確認する.  **二分探索木** (**binary-search tree**) とは, 木の中でも任意の節点の子の数が高々2個となり以下の性質を満たすものである.
ここで, 二分探索木は属性`key` ,`left` ,`right` ,`p`をもち, それぞれ要素, 左の子へのポインタ, 右の子へのポインタ, 親へのポインタを表す.
> 任意の節点$x, y$に対し, $y$が$x$の左部分木内の節点であれば, $y.key \leq x.key$. $y$が$x$の右部分木内の節点であれば, $y.key > x.key$.

```
![bst-fig1](https://github.com/hokto/algorithms/assets/33248495/de7c104d-b900-4d88-b167-f30bea1b4bb1)
*Fig1. 二分探索木の例*
```

二分探索木の利点は, 節点の挿入・削除の計算量が木の高さ$h$に対し, $O(h)$で済む点である.
そしてその高さは**平均的に**$h=O(\log n)$である. (証明略)\
ここで, 最悪計算量を考えると, 節点集合$V=\{v_1,...,v_n| \forall i.[v_i.key< v_{i+1}.key]\}$で$v_1$から順に挿入していくと, 右部分木に順に挿入されていくため, この木の高さは$h=n$となってしまう.
```
![bst-fig2](https://github.com/hokto/algorithms/assets/33248495/13bb363e-a5d4-44f8-a871-195798f21e3b)
*Fig2. 二分探索木の悪い入力例 (1,2,3,4,9の順に挿入した場合)*
```
つまり, 最悪$O(n)$となってしまい効率的とは言えない. よって, より高さが低く保たれる, もっと言うと左右に上手くバランスされるような二分探索木を作成したい. これが赤黒木のモチベーションである.

## 赤黒木の仕組み
**赤黒木** (**red-black tree**)は, 二分探索木でかつ根から任意の葉までのパスの長さが高々2倍のオーダーで抑えられる性質をもつ. つまり, 単なる二分探索木よりも左右が上手にバランスされやすく, 実際, 挿入・削除のオーダーは木の高さが$h=\lg n$で収まることから$O(\lg n)$となる.\
赤黒木は, 名前の通り節点が赤色もしくは黒色であるような色の属性`color`を持つ. そして, 赤黒木は以下の性質 (**red-black properties**)を満たす.
>1. 全ての節点の`color`属性は赤 (*RED*) か黒 (*BLACK*) のいずれかである.
>1. 根は黒色である.
>1. 全ての葉は黒色である.
>1. 赤色の節点が隣接することはない.
>1. 任意の節点において, その子孫となる葉への単純パス上の黒色の節点の個数 (以降, **黒高さ** (**black-height**)と呼ぶ)はどれも同じである.

```
ここに赤黒木の画像を差し込む
```

この性質を満たすことで赤黒木では次の定理が成り立つ.
>### 定理1
> 内部節点の個数が$n$である赤黒木の高さは高々$2\lg{(n+1)}$である.
<details>
<summary>定理1の証明</summary>

任意の節点$x$の黒高さを$bh(x)$とする. \
まず, 次の補題が成立することを示す.
> ### 補題1
> 任意の節点$x$を根とする部分木が少なくとも$2^{bh(x)}-1$個の内部節点を持つ

これは, $x$の高さによる帰納法を用いることで簡単に証明可能である.\
$x$の高さを$h$とし, $h=0$を考えると, $x$は葉であることから内部節点は$$2^{bh(x)}-1=2^0-1=0$$
となり, 成立する.\
次に, 任意の$k\in \mathbb{Z}^+$に対し, $h=k$以下で補題1が成立すると仮定する. この時, $x$の高さが$h=k+1$となり2つの子を持つときについて考える. もし2つの子の場合に成立するのであれば, 当然子が2つ未満であっても成立するため一般性を失うことなく, 2つの場合のみ考える.\
それぞれの子は, $x$が赤色なら$bh(x)$, $x$が黒色なら$bh(x)-1$である. $x$の子の高さは$h$以下であることから, 帰納法の仮定から, $x$の子のそれぞれの内部節点の個数は少なくとも$$2^{bh(x)-1}-1$$となる.
よって, $x$の内部節点の個数は,
$$2\cdot (2^{bh(x)-1}-1)+1=2^{bh(x)}-1$$
となり, 補題1を示すことができた.\
続いて, 本題の定理の証明を行う.\
$h$を木の高さとした時, 赤黒木の性質4から根から葉への任意の単純パス上には黒色の節点が少なくとも半分は含まれる. これは, 赤色の節点が隣り合わず, パス長が偶数の場合は明らか, 奇数であっても根と葉が黒色であるため明らかである.\
この結果から, 根の黒高さは少なくとも$h/2$であるとわかる. すなわち, 補題1から,
$$ n\geq 2^{h/2}-1$$
となる. あとは両辺に1を足し, $\lg{}$を取れば,
$$\lg{(n+1)}\geq h/2 $$
つまり $$h\leq 2\lg{(n+1)}$$となり, 題意が示された.$\square$
</details>

## 実装上の注意
葉の子節点や根の親節点は存在しないため, 便宜上`NIL`と表現するが, 今回の場合はループで処理することが多いため, `NIL`の代わりに番兵`T.NIL`を用いる.\
つまり, `T.NIL`も他の節点と同様に`color`,`key`,`left`, `right`, `p`といった属性を持つオブジェクトとして扱うが, `color`以外は任意の値を持つ.